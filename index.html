<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBIP Impact Analyzer - Power BI Refactoring Tool</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Playfair+Display:wght@400;700;900&family=Source+Serif+4:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>PBIP Impact Analyzer</h1>
            <p class="subtitle">Safely refactor Power BI semantic models with confidence</p>
        </header>

        <!-- Project Header Section -->
        <section class="project-header">
            <!-- Left: Folder Selection and Project Info -->
            <div class="project-info-section">
                <button id="selectFolderBtn" class="btn btn-primary">
                    <span class="material-symbols-outlined">folder_open</span>
                    Select Project Folder
                </button>

                <!-- Selection Summary -->
                <div id="selectionSummary" class="selection-summary hidden">
                    <div class="selection-item">
                        <span class="label"><span class="material-symbols-outlined">folder</span> Project:</span>
                        <span id="selectedProject" class="value">-</span>
                    </div>
                    <div class="selection-item">
                        <span class="label"><span class="material-symbols-outlined">analytics</span> Semantic Model:</span>
                        <span id="selectedSemanticModel" class="value">-</span>
                    </div>
                    <div class="selection-item">
                        <span class="label"><span class="material-symbols-outlined">description</span> Report:</span>
                        <span id="selectedReport" class="value">None</span>
                    </div>
                </div>

                <div id="loadingIndicator" class="loading-indicator hidden">
                    <div class="spinner"></div>
                    <span id="loadingMessage">Parsing PBIP files...</span>
                </div>
            </div>

            <!-- Right: Model Stats -->
            <div id="modelStats" class="model-stats hidden">
                <div class="stat-card">
                    <div class="stat-value" id="measureCount">0</div>
                    <div class="stat-label">Measures</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tableCount">0</div>
                    <div class="stat-label">Tables</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="columnCount">0</div>
                    <div class="stat-label">Columns</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="visualCount">0</div>
                    <div class="stat-label">Visuals</div>
                </div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <nav class="tabs" id="tabNav">
            <button class="tab-btn active" data-tab="impact">
                <span class="material-symbols-outlined">hub</span>
                Impact Analysis
            </button>
            <button class="tab-btn" data-tab="graph">
                <span class="material-symbols-outlined">device_hub</span>
                Lineage
            </button>
            <button class="tab-btn" data-tab="refactor">
                <span class="material-symbols-outlined">construction</span>
                Safe Refactoring
            </button>
        </nav>

        <!-- Tab Content -->
        <main class="tab-content">
            <!-- Impact Analysis Tab -->
            <div id="impact" class="tab-pane active">
                <div class="tab-layout">
                    <!-- Left Sidebar -->
                    <aside class="tab-sidebar">
                        <h2>Impact Analysis</h2>
                        <p class="description">Analyze dependencies when renaming or deleting a measure or column</p>

                        <div class="form-group">
                            <label for="objectTypeSelect">Object Type:</label>
                            <select id="objectTypeSelect" class="select">
                                <option value="">-- Select object type --</option>
                                <option value="measure">Measure</option>
                                <option value="column">Column</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="objectSelect">Select Object:</label>
                            <select id="objectSelect" class="select">
                                <option value="">-- Select a measure or column --</option>
                            </select>
                        </div>

                        <button id="analyzeBtn" class="btn btn-primary btn-full-width" disabled>Analyze Impact</button>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="tab-main-content">
                        <div id="impactResults" class="results hidden">
                            <!-- Selected Object Panel -->
                            <div class="selected-object-panel">
                                <h3 id="selectedObjectName">Measure Name</h3>
                                <div class="dax-display hidden" id="selectedObjectDAX">
                                    <pre><code><!-- DAX code will be displayed here --></code></pre>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div id="impactActions" class="impact-actions hidden">
                                <button id="viewLineageBtn" class="btn btn-secondary">
                                    <span class="material-symbols-outlined">device_hub</span>
                                    View Lineage
                                </button>
                                <button id="proceedToRefactorBtn" class="btn btn-primary">
                                    <span class="material-symbols-outlined">arrow_forward</span>
                                    Proceed to Refactoring
                                </button>
                                <button id="exportCSVBtn" class="btn btn-secondary">
                                    <span class="material-symbols-outlined">download</span>
                                    Export CSV
                                </button>
                            </div>

                            <!-- Split View: Upstream | Downstream -->
                            <div class="impact-split-view">
                                <!-- Upstream Column -->
                                <div class="impact-column upstream-column">
                                    <h3>Upstream Dependencies</h3>
                                    <div class="impact-summary">
                                        <span class="count" id="upstreamCount">0</span> total
                                    </div>

                                    <div class="dependency-section">
                                        <button class="section-toggle" data-section="upstream-tables">
                                            <span class="toggle-icon material-symbols-outlined">expand_more</span> Tables (<span id="upstreamTablesCount">0</span>)
                                        </button>
                                        <div id="upstreamTablesList" class="dependency-list"></div>
                                    </div>

                                    <div class="dependency-section">
                                        <button class="section-toggle" data-section="upstream-columns">
                                            <span class="toggle-icon material-symbols-outlined">expand_more</span> Columns (<span id="upstreamColumnsCount">0</span>)
                                        </button>
                                        <div id="upstreamColumnsList" class="dependency-list"></div>
                                    </div>

                                    <div class="dependency-section">
                                        <button class="section-toggle" data-section="upstream-measures">
                                            <span class="toggle-icon material-symbols-outlined">expand_more</span> Measures (<span id="upstreamMeasuresCount">0</span>)
                                        </button>
                                        <div id="upstreamMeasuresList" class="dependency-list"></div>
                                    </div>
                                </div>

                                <!-- Downstream Column -->
                                <div class="impact-column downstream-column">
                                    <h3>Downstream Dependents</h3>
                                    <div class="impact-summary">
                                        <span class="count" id="downstreamCount">0</span> total
                                    </div>

                                    <div class="dependency-section">
                                        <button class="section-toggle" data-section="downstream-measures">
                                            <span class="toggle-icon material-symbols-outlined">expand_more</span> Measures (<span id="downstreamMeasuresCount">0</span>)
                                        </button>
                                        <div id="downstreamMeasuresList" class="dependency-list"></div>
                                    </div>

                                    <div class="dependency-section">
                                        <button class="section-toggle" data-section="downstream-visuals">
                                            <span class="toggle-icon material-symbols-outlined">expand_more</span> Visuals (<span id="downstreamVisualsCount">0</span>)
                                        </button>
                                        <div id="downstreamVisualsList" class="dependency-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Placeholder when no results -->
                        <div id="impactPlaceholder" class="content-placeholder">
                            <div class="placeholder-icon">
                                <span class="material-symbols-outlined placeholder-mat-icon">search</span>
                            </div>
                            <p>Select an object type and object to analyze its dependencies</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Safe Refactoring Tab -->
            <div id="refactor" class="tab-pane">
                <div class="tab-layout">
                    <!-- Left Sidebar -->
                    <aside class="tab-sidebar">
                        <h2>Safe Refactoring</h2>
                        <p class="description">Rename measures or columns with preview</p>

                        <div class="refactor-tip">
                            <span class="material-symbols-outlined">info</span>
                            <span>Tip: Use <strong>Impact Analysis</strong> first</span>
                        </div>

                        <div class="form-group">
                            <label for="refactorTypeSelect">Object Type:</label>
                            <select id="refactorTypeSelect" class="select">
                                <option value="measure">Measure</option>
                                <option value="column">Column</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="refactorObjectSelect">Select Object:</label>
                            <select id="refactorObjectSelect" class="select">
                                <option value="">-- Select a measure or column --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="newNameInput">New Name:</label>
                            <input type="text" id="newNameInput" class="input" placeholder="Enter new name">
                        </div>

                        <button id="previewBtn" class="btn btn-primary btn-full-width" disabled>Preview Changes</button>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="tab-main-content">
                        <div id="previewResults" class="results hidden">
                            <h3>Preview Changes</h3>
                            <p class="warning-message">
                                <span class="material-symbols-outlined">warning</span>
                                Review all changes carefully before applying
                            </p>
                            <div id="changesList" class="changes-list"></div>
                            <div class="preview-actions">
                                <button id="applyChangesBtn" class="btn btn-success">Apply All Changes</button>
                                <button id="cancelChangesBtn" class="btn btn-secondary">Cancel</button>
                            </div>
                        </div>

                        <!-- Placeholder when no preview -->
                        <div id="refactorPlaceholder" class="content-placeholder">
                            <div class="placeholder-icon">
                                <span class="material-symbols-outlined placeholder-mat-icon">edit</span>
                            </div>
                            <p>Select an object and enter a new name to preview changes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lineage Tab -->
            <div id="graph" class="tab-pane">
                <div class="graph-header">
                    <div>
                        <h2>Lineage</h2>
                        <p class="description">Visual lineage showing upstream dependencies and downstream dependents</p>
                    </div>
                    <div class="graph-controls">
                        <button id="exportGraphBtn" class="btn btn-secondary">
                            <span class="material-symbols-outlined">image</span>
                            Export as PNG
                        </button>
                    </div>
                </div>

                <div id="graphContainer" class="graph-container">
                    <div class="lineage-placeholder">
                        <div class="placeholder-icon">
                            <span class="material-symbols-outlined placeholder-mat-icon">schedule</span>
                        </div>
                        <p>Select an object in Impact Analysis to view its lineage</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer>
            <p>
                <a href="https://github.com/JonathanJihwanKim/pbip-impact-analyzer" target="_blank">GitHub</a> |
                Built with <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;color:var(--accent-red)">favorite</span> for the Power BI community
            </p>
        </footer>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Scripts -->
    <script src="fileAccess.js"></script>
    <script src="parsers.js"></script>
    <script src="analyzer.js"></script>
    <script src="refactor.js"></script>
    <script src="graph.js"></script>
    <script src="app.js"></script>
</body>
</html>
